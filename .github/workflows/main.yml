name: "Orquestração Terraform"

on:
  push:
    branches:
      - main  # Executa quando há um push na branch main
  workflow_dispatch:  # Permite rodar manualmente via GitHub Actions

jobs:
  configurar-credenciais:
    uses: ./.github/workflows/configurar-credenciais.yml

  configurar-terraform:
    needs: configurar-credenciais
    uses: ./.github/workflows/configurar-terraform.yml

  terraform-plan:
    needs: configurar-terraform
    uses: ./.github/workflows/terraform-plan.yml

  approval:
    needs: terraform-plan
    uses: ./.github/workflows/terraform-approval.yml
    with:
      approve: ${{ github.event.inputs.approve || 'no' }}

  terraform-apply:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.approve == 'yes'
    needs: approval
    uses: ./.github/workflows/terraform-apply.yml
