name: "Orquestração Terraform"

on:
  push:
    branches:
      - main  # Executa quando há um push na branch main
  workflow_dispatch:  # Permite rodar manualmente via GitHub Actions

jobs:
  configurar-credenciais:
    uses: ./.github/workflows/aws-credencial.yml
    secrets:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

#  configurar-terraform:
#    needs: configurar-credenciais
#    uses: ./.github/workflows/terraform-config.yml

  terraform-plan:
    needs: configurar-terraform
    uses: ./.github/workflows/terraform-plan.yml

  approval:
    needs: terraform-plan
    uses: ./.github/workflows/terraform-approval.yml
    with:
      approve: ${{ github.event.inputs.approve || 'no' }}

  terraform-apply:
    if: github.event.inputs.approve == 'yes'
    needs: approval
    uses: ./.github/workflows/terraform-apply.yml
